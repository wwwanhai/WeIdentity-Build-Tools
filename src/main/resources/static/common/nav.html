<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>WeId-Web-Tool</title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="../plugins/jquery-ui/jquery-ui.min.css">
  <script src='../plugins/jquery-ui/jquery-ui.min.js'></script>
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">
  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <!-- Left navbar links -->
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#"><i class="fas fa-bars"></i></a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <a href="index.html" class="nav-link">主页</a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <a id="openLog" href="#" class="nav-link">后台日志</a>
      </li>
    </ul>
      
    <ul class="navbar-nav ml-auto" style="display: none">
      <li class="nav-item dropdown" style="float: right;">
        <a class="nav-link" data-toggle="dropdown" href="#">环境切换 : 生产环境</a>
        <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item"> 生产环境 (prd)</a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item"> 测试环境 (stg)</a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item"> 开发环境 (dev)</a>
        </div>
      </li>
    </ul>
  </nav>
  <!-- /.navbar -->
</div>

<div id="dialog" title="后台日志">
  <div id='logContent'></div>
</div>
</div>
</body>
<script>
$(document).ready(function(){
    var websocket = null;
    var str = ''
    if ('WebSocket' in window) {
      websocket = new WebSocket("ws://" + window.location.host + "/webSocket");
    } else {
      alert('当前浏览器不支持WebSocket');
      return;
    }

    // 连接发生错误的回调方法
    websocket.onerror = function () {
      // $("#logContent").html($("#logContent").html() + "<p>日志连接发生错误</p>");
      str = str + "<p>日志连接发生错误</p>"
    };

    // 连接成功建立的回调方法
    websocket.onopen = function () {
      // $("#logContent").html($("#logContent").html() + "<p>日志连接成功</p>");
      str = str + "<p>日志连接成功</p>"
    }

    // 接收到消息的回调方法
    websocket.onmessage = function (event) {
      // $("#logContent").html($("#logContent").html() +"<div>" + event.data + "</div>");
      str = str + "<div>" + event.data + "</div>"
      // window.location.href="#buttom"
    }
        
    // 连接关闭的回调方法
    websocket.onclose = function () {
      // $("#logContent").html($("#logContent").html() + "<p>日志连接关闭</p>");
      str = str + "<p>日志连接关闭</p>"
    }
    //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
    window.onbeforeunload = function () {
    	closeWebSocket();
    }

    // 关闭WebSocket连接
    function closeWebSocket() {
      websocket.close();
    }
    
    $("#openLog").click(function(){
        // var win = window.open("","logWin","width=800,height=500,top=300,left=500");
        // if (win.location.href === "about:blank") {
        //     //窗口不存在
        //     win = window.open("log.html", "logWin","width=800,height=500,top=300,left=500");
        // } else {
        //     //窗口以已经存在了
        //     win.focus();
        // }
        $("#dialog" ).dialog({
          bgiframe:  true ,
          resizable:  false ,
          height: 550 ,
          width: 850,
          modal:  true ,
          overlay: {
              backgroundColor:  ' #000 ' ,
              opacity:  0.5
          },
          open: function(){
            $("#logContent").html(str)  
          }
        })
      })
})
</script>
</html>